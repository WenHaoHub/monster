<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      .tab{
        clear: both;
        width: 100%;
      }
      .needfloat{
        width: 300px;
        height: auto;
        float: left;
      }
      #headImgBox{
        /* width: 100px;  多张图片宽度不固定*/
        height: 50px;
        border: 1px solid #999999;
      }
      #headImgBox img{
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="needfloat">
    <h3>班级管理</h3>
    <label for="">班级名称</label><input type="text" id="classname"><br>
    <!-- <label for="">辅导员</label><input type="text" id="classteacher"><br> -->
    <select name="" id="teacherssel"></select>
    <button id="classBtn">添加班级</button>
  </div>
  <div class="needfloat">
    <h3>教师管理</h3>
    <label for="">姓名</label><input type="text" id="teachersname"><br>
    <label for="">年龄</label><input type="text" id="teachersage"><br>
    <button id="teachersBtn">添加教师</button>
  </div>
  <div class="needfloat">
    <h3>新增学生</h3>
    <label for="">姓名</label><input type="text" id="addname"><br>
    <label for="">年龄</label><input type="text" id="addage"><br>
    <label for="">性别</label>
    <input type="radio" value="男" name="sex" checked="checked"><label for="">男</label>
    <input type="radio" value="女" name="sex"><label for="">女</label></br>
    <label for="">班级</label><select name="addclass" id="addclass"></select><br>
    <!-- 单张图片操作 -->
    <!-- <label for="">头像</label><input type="file" id="addimg"> -->
    <!-- 上传多张图片  multiple打开多选功能 -->
    <label for="">头像</label><input type="file" id="addimg" multiple>
    <div id="headImgBox"></div>
    <button id="addBtn">新增学生</button>
  </div>
  <div class="needfloat">
    <h3>修改学生</h3>
    <label for="">学号</label><input type="text" id="upid"><br>
    <label for="">姓名</label><input type="text" id="upname"><br>
    <label for="">年龄</label><input type="text" id="upage"><br>
    <label for="">性别</label>
    <input type="radio" value="男" name="upsex"><label for="">男</label>
    <input type="radio" value="女" name="upsex"><label for="">女</label><br>
    <button id="upBtn">确认修改</button>
  </div>
  <div class="tab">
    <h3>学生列表</h3>
    <select name="" id="searchType">
      <option value="name">姓名</option>
      <option value="sex">性别</option>
      <option value="age">年龄</option>
      <option value="class">班级</option>
      <option value="teacher">老师</option>
    </select>
    <input type="text" id="searchval">
    <button  id="search">搜索</button>
    <table border="1" cellpadding="0" cellspacing="0">
      <thead>
        <tr>
          <th>头像</th>
          <th>学号</th>
          <th>姓名</th>
          <th>年龄</th>
          <th>性别</th>
          <th>班级</th>
          <th>老师</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div>
      <label for="">显示条数</label>
      <select name="" id="pagesel">
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
      </select>
    </div>
    <div>
      <span>当前页数<b id="newpage"></b>/<b id="allpage"></b></span>
      <span>学生数据总数<b id="allstudents"></b></span>
    </div>
    <div>
      <button id="firstpage">首页</button>
      <button id="prevpage">上一页</button>
      <button id="nextpage">下一页</button>
      <button id="lastpage">尾页</button>
    </div>
  </div>
  
    <script src="jquery/jquery.min.js"></script>
    <script>
      // 搜索条件
      let searchData={
        type:'name',
        value:''
      }
      //翻页相关
      //当first方法页面加载执行完后  会返回相关数据给予赋值
      let pageData={
        size:3,     //显示数据条数
        index:1,    //当前页数
        sumPage:0,     //总页数
        sum:0,         //总数据条数
        rows:[]        //学生数据 
      }

      //统一设置所有的ajax的请求头
      $.ajaxSettings.beforeSend=(xhr)=>{//XMLHttpRequest是一个浏览器接口
        //读取token中保存的当前登录的用户名  是个编译过后的字符串  需要token函数后台编译
        xhr.setRequestHeader('Authorization','Bearer '+localStorage.token)
      }

      //翻页操作
      $('#firstpage').click(()=>{
        if(pageData.index>1){
        pageData.index=1;
        first();
        }
      });
      $('#prevpage').click(()=>{
        //判断  大于总页才能执行
        if(pageData.index>1){
          pageData.index--;
          first();
        }
      });
      $('#nextpage').click(()=>{
        //判断  小于总页数才能执行
        if(pageData.index<pageData.sumPage){
          pageData.index++;
          first();
        }
      });
      $('#lastpage').click(()=>{
        if(pageData.index<pageData.sumPage){
        pageData.index=pageData.sumPage;
        first();
        }
      });
      $('#pagesel').change(()=>{//下拉框改变失焦时触发
        pageData.index=1;//只要动用显示条数下拉框就将显示页面置为首页
        pageData.size=$('#pagesel').val();
        first();
      });
     
      first();//页面
      selectShow();//下拉班级选项框
      teachersShow();//渲染老师下拉框
      tokenLogin();//验证是否登录
      function tokenLogin(){
        $.ajax({
          url:'/users/tokenLogin',
          type:'post',
          //token 携带在请求头中
          // headers:{
          //   'Authorization':'Bearer '+localStorage.token
          // },
          success(msg){
            msg.success?alert(`用户:${msg.username}登录成功`):""
          },
          error(msg){
            if(msg.status==401){//表示token失效  重新登录生效
              location.href='./login.html';
            }
          }
        });
      }
      //渲染学生
      function first() {
        $.ajax({
          url: "/students/getstudents",
          type: "get",
          data:{type:searchData.type,value:searchData.value,size:pageData.size,index:pageData.index},//搜索
          success(msg) {
            // console.log(msg);
            if (msg.success) {
              //将Pagedata重新赋值msg.row返回的是以下对象
                    // { index: "1"
                    // rows: (3) [{…}, {…}, {…}]  这里装着学生数组对象
                    // size: "3"
                    // sum: 10
                    // sumPage: 4 }
              pageData=msg.rows;
              // <td><img width="50px" src="./img/${isme.headimg}"</td>
              //字符串拼接
              let html = pageData.rows.map(isme => {
                return `
                <tr>
                <td>${isme.headimg ? `<img width="50px" src="./img/${isme.headimg}" />` : '暂无数据'}</td>
                <td>${isme._id}</td>
                <td>${isme.name}</td>
                <td>${isme.age}</td>
                <td>${isme.sex}</td>
                <td>${isme.classId.className}</td>
                <td>${isme.classId.teachersId.name}</td>
                <td>
                  <button class="updataBtn" nolyId="${isme._id}">修改</button>
                  <button class="removBtn" nolyId="${isme._id}">删除</button>
                  </td>
            </tr>
                            `;
              });
              $('tbody').html(html.join());
              //赋值页面显示页脚内容
              //  console.log(pageData);
              $('#allpage').html(pageData.sumPage);//总页数
              $('#newpage').html(pageData.index);//当前页数
              $('#allstudents').html(pageData.sum);//总学生数据条数
              $('#pagesel').val(pageData.size);//显示个数
            }
          },
        });
      }
      //删除操作
      $('tbody').on('click','.removBtn',function(){
        const _id=$(this).attr('nolyId');
        // console.log(_id)
        $.ajax({
          url:'/students/delstudentsById',
          type:'post',
          data:{_id},
          success(msg){
            if(msg.success){
              pageData.index=1;
              first()
            }
          }
        });
      });
      //新增学生
      $('#addBtn').click(()=>{
        //获取输入框中的内容
        // const headimg=$('#').val();
        const name=$('#addname').val();
        const age=$('#addage').val();
        const sex=$('[name="sex"]:checked').val();
        const classId=$('#addclass').val();//班级
        const headimg=$('#headImgBox>img').attr('data-img');//头像  从自定义属性里获取
        console.log(headimg);
        $.ajax({
          url:'/students/addstudents',
          type:'post',
          data:{name,age,sex,classId,headimg},
          success(msg){
            if(msg.success){
              //添加成功从新渲染页面
              first()
            }
          }
        });
      });

      //1.修改学生  先通过修改键获取数据
      $('tbody').on('click','.updataBtn',function(){//要查询自定义内容，不能用箭头函数
        //通过唯一的id值
        const _id=$(this).attr('nolyId');
        $.ajax({
          url:'/students/updatastudentsById',
          type:'post',
          data:{_id},
          success(msg){
            // console.log(msg);
            //msg.rows[0]就是被修改学生的数据
            if(msg.success){//数据请求成功后将数据打印到修改界面
              const {_id,name,age,sex}=msg.rows[0];
              $('#upid').val(_id);
              $('#upname').val(name);
              $('#upage').val(age);
              //给读取到的性别添加默认选项
              $(`[name="upsex"][value="${sex}"]`).prop('checked',true);
            }
          }
        });
      });
      // 2.修改学生 在通过确认修改将信息保存
      $('#upBtn').click(()=>{
        //获取id供第三层修改使用
        const _id=$('#upid').val();
        //获取输入框中的内容
        const name=$('#upname').val();
        const age=$('#upage').val();
        const sex=$('[name="upsex"]:checked').val();
        console.log(_id,name,age,sex);
        $.ajax({
          url:'/students/updataTwostudentsById',
          type:'post',
          data:{_id,name,age,sex},
          success(msg){
            if(msg.success){
              //添加成功从新渲染页面
              first()
            }
          }
        });
      });
   
      //搜索
      $('#search').click(function(){
        //给全局变量赋值
        searchData.type=$('#searchType').val();
        searchData.value=$('#searchval').val();
        pageData.index=1;//搜索将显示页面置为首页  防错
        first();
      });
      //渲染班级下拉框
      function selectShow(){
        $.ajax({
          url:'/classes/getclass',
          type:'get',
          success(msg){
            // console.log(msg)
            let optionHtml=msg.rows.map(isme=>`<option value="${isme._id}">${isme.className}</option>`).join();//return  {}省略了
            $('#addclass').html(optionHtml);//追加程序
          }
        });
      }
      //添加班级
      $('#classBtn').click(function(){
        const className=$('#classname').val();
        const teachersId=$('#teacherssel').val();
        // console.log(className,classTeacher);
        $.ajax({
          url:'/classes/addclass',
          type:'post',
          data:{className,teachersId},
          success(msg){
            // console.log(msg)
            selectShow()
          }
        });
      });
          //渲染老师下拉框下拉框
      function teachersShow(){
        $.ajax({
          url:'/teachers/getteachers',
          type:'get',
          success(msg){
            // console.log(msg)
            let optionHtml=msg.rows.map(isme=>`<option value="${isme._id}">${isme.name}</option>`).join();//return  {}省略了
            $('#teacherssel').html(optionHtml);//追加程序
          }
        });
      }  
        //添加老师
      $('#teachersBtn').click(function(){
        const name=$('#teachersname').val();
        const age=$('#teachersage').val();
        console.log(name,age);
        $.ajax({
          url:'/teachers/addteachers',
          type:'post',
          data:{name,age},
          success(msg){
            // console.log(msg)
            teachersShow()
          }
        });
      });
      //添加图片头像
      $('#addimg').change((e)=>{
        const files=e.target.files;
        // console.log(e.target.files)
        // 获取上传的图片信息   在选择图片过后触发
        // 创建表单对象
        const formData=new FormData();
        //将图片信息添加到表单对象中
        // formData.append('headimg',files[0]);  单张图片
        for (const isme of files) {
          formData.append('file',isme);//headimg跟后端接口地址
        }
        $.ajax({
          url:'/imgs/upload',
          type:'post',
          data:formData,
          cache:false,        //禁止jquery插件对  form对象进行相关配置
          contentType:false,
          processData:false,
          success(msg){//msg.filename返回的是图片名称
            // console.log(msg);
            if(msg.success){//上传成功
              $("#headImgBox").html('');//清空  保持显示一张图片

              //appendTo  将谁追加到谁里  跟append相反   单张图片操作
              // $('<img>').attr('src',`./imgtemp/${msg.filename}`).attr('data-img',`${msg.filename}`).appendTo($('#headImgBox'));

              //多张图片操作  遍历返回的图片名称数组
              $('#headImgBox').html(msg.filename.map(isme=>`<img src="./imgtemp/${isme}" data-img="${isme}" />`).join(''));
            }
          }
        });
      });
  </script>
  </body>
</html>
